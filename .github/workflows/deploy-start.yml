# Reusable workflow: prepare and start a deployment.
#
# Purpose:
#
# - Decide whether a deployment should start (comment trigger or other events).
# - Resolve the target environment; supports dynamic environment names when
#   invoked from issue or pull-request events (e.g. `environment:issue_number`).
# - Create a GitHub deployment and set its initial state to `in_progress`.
#
# Trigger:
#
# - Can be triggered by a specific comment.
# - Any event that triggers the workflow that's not an "issue_comment".
#
# Environment:
#
# - Support dynamic env when comming from issue or pull-request event

name: Deploy - Start

on:
  workflow_call:
    inputs:
      runs-on:
        description: |
          JSON array of runner(s) to use.
          See https://docs.github.com/en/actions/using-jobs/choosing-the-runner-for-a-job.
        type: string
        default: '["ubuntu-latest"]'
        required: false
      environment:
        description: |
          Environment where to deploy.
          If trigger is from an issue event (or pull-request), environment will be set to `environment:issue_number`.
          See https://docs.github.com/en/actions/deployment/deploying-to-your-cloud-provider/using-environments-for-deployment.
        type: string
        required: false
      trigger-on-comment:
        description: |
          Comment trigger to start the workflow.
          See https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#issue_comment.
        type: string
        default: "/deploy"
        required: false
    outputs:
      trigger:
        description: "Trigger event that started the workflow."
        value: ${{ jobs.prepare-deploy.outputs.trigger }}
      environment:
        description: "Environment where to deploy."
        value: ${{ jobs.prepare-deploy.outputs.environment }}
      deployment-id:
        description: "Deployment ID to use for the deployment."
        value: ${{ jobs.start-deploy.outputs.deployment-id }}

permissions: {}

jobs:
  prepare-deploy:
    name: Check if should deploy
    runs-on: ${{ fromJson(inputs.runs-on) }}
    permissions:
      contents: read
      id-token: write # Needed for getting local workflow actions
      issues: write
      pull-requests: write
    outputs:
      trigger: ${{ steps.trigger.outputs.trigger }}
      environment: ${{ steps.get-environment.outputs.environment }}
    steps:
      - id: not-created-issue-comment
        if: github.event_name != 'issue_comment'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: return true;

      - uses: shanegenschaw/pull-request-comment-trigger@de309e4a2e83bb08877cada483e3e2b13b8d8e4b # v3.0.0
        id: trigger-on-comment
        if: ${{ !steps.not-created-issue-comment.outputs.result && inputs.trigger-on-comment }}
        with:
          trigger: ${{ inputs.trigger-on-comment }}
          prefix_only: true
          reaction: eyes
        env:
          GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN || github.token }}"

      - id: trigger
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        if: ${{ steps.not-created-issue-comment.outputs.result || steps.trigger-on-comment.outputs.triggered == 'true' }}
        env:
          NOT_CREATED_ISSUE_COMMENT: ${{ steps.not-created-issue-comment.outputs.result }}
          TRIGGER_ON_COMMENT: ${{ steps.trigger-on-comment.outputs.triggered }}
          EVENT_NAME: ${{ github.event_name }}
        with:
          script: |
            if (process.env.NOT_CREATED_ISSUE_COMMENT === 'true' || process.env.TRIGGER_ON_COMMENT === 'true') {
              core.setOutput('trigger', process.env.EVENT_NAME);
            }

      - id: local-workflow-actions
        uses: hoverkraft-tech/ci-github-common/actions/local-workflow-actions@f5847cb398fe65d53794e6aba98ebdfa0801f691 # 0.32.0
        with:
          actions-path: actions

      - id: get-environment
        if: ${{ steps.trigger.outputs.trigger }}
        uses: ./self-workflow/actions/deploy/get-environment
        with:
          environment: ${{ inputs.environment }}

      # jscpd:ignore-start
      - uses: hoverkraft-tech/ci-github-common/actions/local-workflow-actions@f5847cb398fe65d53794e6aba98ebdfa0801f691 # 0.32.0
        if: always() && steps.local-workflow-actions.outputs.repository
        with:
          actions-path: actions
          repository: ${{ steps.local-workflow-actions.outputs.repository }}
          ref: ${{ steps.local-workflow-actions.outputs.ref }}
      # jscpd:ignore-end

  start-deploy:
    name: Start deploy
    runs-on: ${{ fromJson(inputs.runs-on) }}
    needs: prepare-deploy
    if: needs.prepare-deploy.outputs.trigger
    permissions:
      actions: read
      deployments: write
      id-token: write # Needed for getting local workflow actions
      pull-requests: read
    environment: ${{ needs.prepare-deploy.outputs.environment }}
    outputs:
      deployment-id: ${{ steps.create-deployment.outputs.deployment-id }}
    steps:
      - id: local-workflow-actions
        uses: hoverkraft-tech/ci-github-common/actions/local-workflow-actions@f5847cb398fe65d53794e6aba98ebdfa0801f691 # 0.32.0
        with:
          actions-path: actions

      - id: create-deployment
        uses: ./self-workflow/actions/deployment/create
        with:
          environment: ${{ needs.prepare-deploy.outputs.environment }}

      - uses: ./self-workflow/actions/deployment/update
        with:
          deployment-id: ${{ steps.create-deployment.outputs.deployment-id }}
          state: "in_progress"
          description: "Starting deployment to ${{ needs.prepare-deploy.outputs.environment }}..."

      # jscpd:ignore-start
      - uses: hoverkraft-tech/ci-github-common/actions/local-workflow-actions@f5847cb398fe65d53794e6aba98ebdfa0801f691 # 0.32.0
        if: always() && steps.local-workflow-actions.outputs.repository
        with:
          actions-path: actions
          repository: ${{ steps.local-workflow-actions.outputs.repository }}
          ref: ${{ steps.local-workflow-actions.outputs.ref }}
      # jscpd:ignore-end
