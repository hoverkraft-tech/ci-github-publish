name: "Deploy - ArgoCD Manifest Files"
author: Hoverkraft
branding:
  icon: file-text
  color: blue
# jscpd:ignore-start
description: |
  Prepares the ArgoCD manifest files for deployment.
  Fills in the required fields and updates the Helm chart values.
  This action is used to deploy an application using ArgoCD.
  It updates the application manifest with the provided values and deploys it to the specified namespace.

  ### Updated Helm chart values

  1. Common updates:

  - All values provided in the `chart-values` input are injected into the Helm chart at their specified YAML paths. Each entry must include a `path` (YAML key) and a `value`.
  - The deployment ID is automatically added to the chart values as `.deploymentId`, allowing the chart to reference the current deployment instance.
  - The step validates that each chart value entry contains both `path` and `value` properties, ensuring correct input structure.

  2. Vendor-specific updates for the chart version and other properties:

  - Updates the `tags.datadoghq.com/version` key to the chart version in Helm values.

  ### Files/paths updated by this action

  1. The ArgoCD application manifest file (input `application-file`) is updated with:

  - Metadata:
    - Name: set to the target namespace
    - Annotations:
      - "argocd.argoproj.io/application-repository": set to the application repository
      - "argocd.argoproj.io/deployment-id": set to the deployment ID
  - Spec:
    - Destination:
      - Namespace: set to the target namespace
    - Source or Sources: supports both singular `source` and multiple `sources` array formats
      - Chart/RepoURL: validated against the provided `chart-name` and `chart-repository` inputs; the action fails if they do not match the manifest contents
      - TargetRevision: set to the Helm chart version
      - Source Selection: when multiple `sources` entries exist, only the entry (or entries) whose chart and repoURL match the provided inputs is updated; the action fails if no entry matches
      - Plugin - hoverkraft-deployment (if exists in source or any sources[]):
        - Environment variable `HOVERKRAFT_DEPLOYMENT_ID`: updated with the deployment ID to trigger sync detection
      - Helm Values:
        - Chart values: custom values provided via the `chart-values` input, allowing dynamic configuration of the Helm chart (e.g., application URIs, feature flags).
        - Deployment ID: injected as a value to identify the deployment instance within the chart values.
        - Vendor-specific values: additional values set for integrations, such as updating `tags.datadoghq.com/version` for Datadog monitoring/versioning.

  Example with singular `source` format:

  ```yaml
  metadata:
    name: my-namespace
    annotations:
      argocd.argoproj.io/application-repository: https://github.com/my-org/my-app
      argocd.argoproj.io/deployment-id: deploy-1234
  spec:
    destination:
      namespace: my-namespace
    source:
      chart: my-chart
      repoURL: https://charts.example.com
      targetRevision: 1.2.3
      # If using ArgoCD plugin (optional):
      plugin:
        name: hoverkraft-deployment
        env:
          - name: HOVERKRAFT_DEPLOYMENT_ID
            value: deploy-1234
      helm:
        values:
          application:
            appUri: https://my-app-review-app-1234.my-org.com
          deploymentId: deploy-1234
          tags:
            datadoghq.com:
              version: 1.2.3
  ```

  Example with multiple `sources` array format:

  ```yaml
  metadata:
    name: my-namespace
    annotations:
      argocd.argoproj.io/application-repository: https://github.com/my-org/my-app
      argocd.argoproj.io/deployment-id: deploy-1234
  spec:
    destination:
      namespace: my-namespace
    sources:
      - chart: my-chart
        repoURL: https://charts.example.com
        targetRevision: 1.2.3
        # If using ArgoCD plugin (optional):
        plugin:
          name: hoverkraft-deployment
          env:
            - name: HOVERKRAFT_DEPLOYMENT_ID
              value: deploy-1234
        helm:
          values:
            application:
              appUri: https://my-app-review-app-1234.my-org.com
            deploymentId: deploy-1234
            tags:
              datadoghq.com:
                version: 1.2.3
  ```

  2. The extra manifest file (input `manifest-file`) is updated with:

  - Metadata:
    - Name: set to the target namespace (if the `metadata.name` field exists)
    - Annotations:
      - "app.kubernetes.io/instance": set to the target namespace (if the annotation exists)
    - Namespace: set to the target namespace (if the `metadata.namespace` field exists)

  Example:

  ```yaml
  metadata:
    name: my-namespace
    annotations:
      app.kubernetes.io/instance: my-namespace
  ```
# jscpd:ignore-end
inputs:
  deployment-id:
    description: "Deployment ID to be used in the ArgoCD application manifest"
    required: true
  namespace:
    description: "Namespace to deploy the application"
    required: true
  chart-name:
    description: "Name of the Helm chart"
    required: true
  chart-repository:
    description: "Repository URL of the Helm chart"
    required: true
  chart-version:
    description: "Version of the Helm chart"
    required: true
  chart-values:
    description: |
      Values to be replaced in the chart.
      Example:
      ```json
      [
        { "path": "application.appUri", "value": "https://my-app-review-app-1234.my-org.com" }
      ]
      ```
    required: false
  application-repository:
    description: "Repository of the application"
    required: true
  application-file:
    description: "Path to the application manifest file"
    required: true
  manifest-file:
    description: "Path to the extra manifest file"
    required: true
  initiated-by:
    description: "Username to record as having initiated the sync operation"
    required: true

runs:
  using: "composite"
  steps:
    - id: common-chart-yq-updates
      uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
      with:
        script: |
          const chartValuesInput = ${{ toJSON(inputs.chart-values) }};
          let chartValues = null;
          try {
            chartValues = JSON.parse(chartValuesInput);
          } catch (error) {
            core.setFailed(`"chart-values" input is not a valid JSON: ${error}`);
            return;
          }

          if (!Array.isArray(chartValues)) {
            core.setFailed(`"chart-values" input is not an array`);
            return;
          }

          // Check each item
          for (const key in chartValues) {
            // Check mandatory properties
            for (const property of ['path', 'value']) {
              if (!chartValues[key].hasOwnProperty(property)) {
                core.setFailed(`"chart-values[${key}].${property}" is missing`);
                return;
              }
            }
          }

          // Add deployment ID to each chart value
          chartValues.push({
            path: ".deploymentId",
            value: "${{ inputs.deployment-id }}"
          });

          const yqUpdates = chartValues.map(chartValue => `${chartValue.path} = "${chartValue.value}" |`).join("\n");

          core.setOutput('cmd', yqUpdates);

    - id: vendor-specific-chart-yq-updates
      uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
      with:
        script: |
          // Datadog
          const yqUpdates = `(.. | select(has("tags.datadoghq.com/version")))."tags.datadoghq.com/version" = "${{ inputs.chart-version }}" |`;

          core.setOutput('cmd', yqUpdates);

    - id: update-application-file
      uses: mikefarah/yq@7ccaf8e700ce99eb3f0f6cef7f5930a0b3c827cd # v4.49.2
      with:
        cmd: |
          # Update ArgoCD Application manifest file
          yq -i '
            .metadata.name = "${{ inputs.namespace }}" |
            .metadata.annotations["argocd.argoproj.io/application-repository"] = "${{ inputs.application-repository }}" |
            .metadata.annotations["argocd.argoproj.io/deployment-id"] = "${{ inputs.deployment-id }}" |
            .spec.destination.namespace = "${{ inputs.namespace }}"
          ' ${{ inputs.application-file }}

          # Detect whether the manifest uses singular 'source' or 'sources' array
          if [ "$(yq eval '.spec | has("source")' ${{ inputs.application-file }})" = "true" ]; then
            # Singular source format
            current_chart=$(yq eval -r '.spec.source.chart // ""' ${{ inputs.application-file }})
            if [ "$current_chart" != "${{ inputs.chart-name }}" ]; then
              echo "::error::ArgoCD manifest chart ('$current_chart') does not match input chart-name ('${{ inputs.chart-name }}')"
              exit 1
            fi

            current_repo=$(yq eval -r '.spec.source.repoURL // ""' ${{ inputs.application-file }})
            if [ "$current_repo" != "${{ inputs.chart-repository }}" ]; then
              echo "::error::ArgoCD manifest repoURL ('$current_repo') does not match input chart-repository ('${{ inputs.chart-repository }}')"
              exit 1
            fi

            yq -i '
              .spec.source.targetRevision = "${{ inputs.chart-version }}" |
              .spec.source.helm.values |= (
                  from_yaml |
                  ${{ steps.common-chart-yq-updates.outputs.cmd }}
                  ${{ steps.vendor-specific-chart-yq-updates.outputs.cmd }}
                  to_yaml
              )
            ' ${{ inputs.application-file }}

            # Update plugin env if it exists on source and plugin name is "hoverkraft-deployment"
            if [ "$(yq eval '.spec.source.plugin.name' ${{ inputs.application-file }})" = "hoverkraft-deployment" ]; then
              yq -i '
                (.spec.source.plugin.env[] | select(.name == "HOVERKRAFT_DEPLOYMENT_ID") | .value) = "${{ inputs.deployment-id }}" |
                (.spec.source.plugin.env[] | select(.name == "ARGOCD_MULTI_SOURCES") | .value) = "0"
              ' ${{ inputs.application-file }}
            fi
          else
            # Multiple sources array format
            matching_source_count=$(yq eval '
              (.spec.sources // [])
              | map(select(.chart == "${{ inputs.chart-name }}" and .repoURL == "${{ inputs.chart-repository }}"))
              | length
            ' ${{ inputs.application-file }})

            if [ "$matching_source_count" -eq 0 ]; then
              echo "::error::No entry in spec.sources matches chart '${{ inputs.chart-name }}' and repoURL '${{ inputs.chart-repository }}'"
              exit 1
            fi

            yq -i '
              (.spec.sources[] | select(.chart == "${{ inputs.chart-name }}" and .repoURL == "${{ inputs.chart-repository }}") | .targetRevision) = "${{ inputs.chart-version }}" |
              (.spec.sources[] | select(.chart == "${{ inputs.chart-name }}" and .repoURL == "${{ inputs.chart-repository }}" and has("helm")) | .helm.values) |= (
                  from_yaml |
                  ${{ steps.common-chart-yq-updates.outputs.cmd }}
                  ${{ steps.vendor-specific-chart-yq-updates.outputs.cmd }}
                  to_yaml
              )
            ' ${{ inputs.application-file }}

            # Update plugin env only for matching sources where plugin name is "hoverkraft-deployment"
            yq -i '
              (
                .spec.sources[]
                | select(.chart == "${{ inputs.chart-name }}" and .repoURL == "${{ inputs.chart-repository }}")
                | select(.plugin.name == "hoverkraft-deployment")
                | .plugin.env[]
                | select(.name == "HOVERKRAFT_DEPLOYMENT_ID")
                | .value
              ) = "${{ inputs.deployment-id }}" |
              (
                .spec.sources[]
                | select(.chart == "${{ inputs.chart-name }}" and .repoURL == "${{ inputs.chart-repository }}")
                | select(.plugin.name == "hoverkraft-deployment")
                | .plugin.env[]
                | select(.name == "ARGOCD_MULTI_SOURCES")
                | .value
              ) = "1"
            ' ${{ inputs.application-file }}
          fi

    - id: update-manifest-file
      uses: mikefarah/yq@7ccaf8e700ce99eb3f0f6cef7f5930a0b3c827cd # v4.49.2
      with:
        cmd: |
          yq -i '
            (select(has("metadata") and .metadata | has("name")) | .metadata.name) = "${{ inputs.namespace }}" |
            (select(has("metadata") and .metadata | has("namespace")) | .metadata.namespace) = "${{ inputs.namespace }}" |
            (select(has("metadata") and .metadata | has("annotations") and .metadata.annotations | has("app.kubernetes.io/instance")) | .metadata.annotations["app.kubernetes.io/instance"]) = "${{ inputs.namespace }}"
          ' ${{ inputs.manifest-file }}
