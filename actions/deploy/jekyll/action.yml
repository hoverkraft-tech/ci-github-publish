name: Build a Jekyll site
description: |
  Builds a Jekyll site from source files with automatic asset management and link rewriting.

  Main steps performed by this action:

  1. **Site Preparation**: Creates the site directory (configurable via `site-path`) and generates `_config.yml` with the specified theme
  2. **Index Page Creation**: Converts README.md to index.md with Jekyll front matter if index doesn't exist
  3. **Additional Pages Processing**: Processes pages (Markdown or HTML) matching the `pages` input pattern, creating Jekyll pages with proper structure
  4. **Asset Management**: Copies images and media files referenced by pages plus any files matched by `assets` input into `assets/`, rewriting references in Markdown and HTML
  5. **Link Rewriting**: Updates internal page links to maintain correct navigation after Jekyll structure transformation
  6. **Jekyll Build**: Executes official Jekyll build process to generate the final static site
author: hoverkraft
branding:
  icon: layers
  color: blue

inputs:
  theme:
    description: "The Jekyll theme to use for the site."
    required: false
    default: "jekyll-theme-cayman"
  pages:
    description: |
      The Jekyll pages path to build. Supports glob patterns and multiple paths (one per line). Accepts Markdown (`.md`, `.markdown`) and HTML (`.html`, `.htm`) files.

      ```yml
      pages: |
        docs/**/*.md
        .github/workflows/*.md
        actions/*/README.md
      ```
    required: false
  assets:
    description: |
      Additional files to copy into the generated `assets/` directory. Supports glob patterns and multiple paths (one per line).

      ```yml
      assets: |
        css/**
        images/**
        media/**/*.png
      ```
    required: false
  site-path:
    description: |
      The working directory where the prepared Jekyll site is written. Relative to the workspace.
      Defaults to `_site`.
    required: false
    default: "_site"
  build-path:
    description: |
      The destination directory for the built site assets. Relative to the workspace. Defaults to `build` when not set.
    required: false
    default: "build"

outputs:
  build-path:
    description: "The path to the built site assets."
    value: "${{ steps.prepare-site.outputs.jekyll-destination }}"

runs:
  using: "composite"
  steps:
    - id: prepare-site
      uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
      with:
        script: |
          const path = require('path');
          const prepareSite = require(path.join(process.env.GITHUB_ACTION_PATH, 'prepare-site.js'));
          await prepareSite({
            core,
            io,
            glob,
            inputs: {
              theme: ${{ toJson(inputs.theme) }},
              pages: ${{ toJson(inputs.pages) }},
              assets: ${{ toJson(inputs.assets) }},
              "site-path": ${{ toJson(inputs.site-path) }},
              "build-path": ${{ toJson(inputs.build-path) }}
            }
          });

    - uses: actions/configure-pages@983d7736d9b0ae728b81ab479565c72886d7745b # v5.0.0

    - name: Build Jekyll site
      uses: actions/jekyll-build-pages@44a6e6beabd48582f863aeeb6cb2151cc1716697 # v1.0.13
      with:
        source: ${{ steps.prepare-site.outputs.jekyll-source }}
        destination: ${{ steps.prepare-site.outputs.jekyll-destination }}

    - shell: bash
      run: sudo chown -R $(whoami) "${{ steps.prepare-site.outputs.jekyll-destination }}"
