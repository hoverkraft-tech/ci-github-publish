name: "Release - Create"
description: "Create or publish a release with Release Drafter, with optional monorepo scoping."
author: hoverkraft
branding:
  icon: bookmark
  color: blue

inputs:
  prerelease:
    description: "Whether the release is a prerelease"
    default: "false"
  publish:
    description: "Whether to publish the release (false keeps it as a draft)"
    default: "true"
  working-directory:
    description: |
      Working directory for monorepo support.
      If specified, the release configuration file will be placed in `.github/release-configs/{slug}.yml` where slug is derived from the working directory path.
      The configuration will include `include-paths` to filter pull requests to only those that modified files in the specified directory.
    type: string
    required: false
    default: ""
  github-token:
    description: |
      GitHub Token for creating the release.
      Permissions:
        - contents: write
        - pull-requests: read
    required: false
    default: ${{ github.token }}

outputs:
  tag:
    description: "The tag of the release"
    value: ${{ steps.get-tag.outputs.tag }}

runs:
  using: "composite"
  steps:
    - shell: bash
      # FIXME: workaround until will be merged: https://github.com/actions/runner/pull/1684
      run: mkdir -p ./self-release-create-actions/ && cp -r $GITHUB_ACTION_PATH/../* ./self-release-create-actions/

    - id: get-configuration
      uses: ./self-release-create-actions/get-configuration
      with:
        working-directory: ${{ inputs.working-directory }}

    - shell: bash
      # FIXME: workaround until will be merged: https://github.com/actions/runner/pull/1684
      run: |
        rm -fr ./self-release-create-actions

    - uses: hoverkraft-tech/ci-github-common/actions/checkout@f5847cb398fe65d53794e6aba98ebdfa0801f691 # 0.32.0
      with:
        fetch-depth: "0"

    - id: release
      uses: release-drafter/release-drafter@6db134d15f3909ccc9eefd369f02bd1e9cffdf97 # v6.2.0
      env:
        GITHUB_TOKEN: ${{ inputs.github-token }}
      with:
        publish: ${{ inputs.publish }}
        # config-name is relative to .github/ directory
        config-name: ${{ steps.get-configuration.outputs.config-name }}
        prerelease: ${{ inputs.prerelease }}
        disable-autolabeler: true
        latest: ${{ inputs.prerelease != 'true' && !inputs.working-directory && 'true' || 'false' }}

    - uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
      id: get-tag
      with:
        script: |
          const tag = `${{ steps.release.outputs.tag_name }}`.trim();
          if (tag.length) {
            core.setOutput("tag", tag);
            return;
          }

          core.setFailed("No tag found from release-drafter outputs");
