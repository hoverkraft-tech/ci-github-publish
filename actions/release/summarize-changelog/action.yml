name: "Release - Summarize changelog"
description: "Compile release changelog entries between two refs, with optional conventional commit grouping and LLM summary injection."
author: hoverkraft
branding:
  icon: file-text
  color: blue

inputs:
  base-ref:
    description: "Base git ref (excluded from the range)."
    required: true
  head-ref:
    description: "Head git ref (included in the range)."
    required: true
  conventional-commits:
    description: "Whether to group commit messages by conventional commit type."
    required: false
    default: "true"
  llm-summary:
    description: "Optional summary generated by any LLM provider."
    required: false
    default: ""
  llm-summary-command:
    description: "Optional command used to generate the summary from `llm-prompt` (prompt is sent through stdin)."
    required: false
    default: ""
  markdown-template:
    description: |
      Markdown template used to build the final changelog.
      Supported placeholders:
      - {{base_ref}}
      - {{head_ref}}
      - {{commit_count}}
      - {{summary}}
      - {{changes}}
    required: false
    default: |
      ## Changelog

      _Changes from `{{base_ref}}` to `{{head_ref}}`._

      {{summary}}

      {{changes}}

outputs:
  changelog:
    description: "Rendered markdown changelog."
    value: ${{ steps.summarize.outputs.changelog }}
  changes:
    description: "Compiled markdown list of changes."
    value: ${{ steps.summarize.outputs.changes }}
  llm-prompt:
    description: "Prompt text that can be sent to any LLM provider."
    value: ${{ steps.summarize.outputs.llm-prompt }}
  commit-count:
    description: "Number of commits included in the changelog."
    value: ${{ steps.summarize.outputs.commit-count }}

runs:
  using: "composite"
  steps:
    - uses: hoverkraft-tech/ci-github-common/actions/checkout@f24ce3360a8abf9bf386a62ab13d0ae5de5f9d13 # 0.31.7
      with:
        fetch-depth: "0"

    - id: summarize
      uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
      env:
        BASE_REF: ${{ inputs.base-ref }}
        HEAD_REF: ${{ inputs.head-ref }}
        CONVENTIONAL_COMMITS: ${{ inputs.conventional-commits }}
        LLM_SUMMARY: ${{ inputs.llm-summary }}
        LLM_SUMMARY_COMMAND: ${{ inputs.llm-summary-command }}
        MARKDOWN_TEMPLATE: ${{ inputs.markdown-template }}
      with:
        script: |
          const { execSync } = require("node:child_process");

          const baseRef = process.env.BASE_REF.trim();
          const headRef = process.env.HEAD_REF.trim();
          const useConventionalCommits = process.env.CONVENTIONAL_COMMITS.trim() === "true";
          const llmSummaryInput = process.env.LLM_SUMMARY.trim();
          const llmSummaryCommand = process.env.LLM_SUMMARY_COMMAND.trim();
          const markdownTemplate = process.env.MARKDOWN_TEMPLATE;

          if (!baseRef || !headRef) {
            core.setFailed("Both base-ref and head-ref inputs are required.");
            return;
          }

          const rawLog = execSync(
            `git log --no-merges --pretty=format:%s ${baseRef}..${headRef}`,
            { encoding: "utf8" },
          ).trim();

          const commits = rawLog ? rawLog.split("\n").map((line) => line.trim()).filter(Boolean) : [];
          const groupedCommits = commits.reduce((acc, subject) => {
            const match = subject.match(/^(?<type>[a-z]+)(?:\([^)]+\))?(?:!)?:\s+(?<description>.+)$/i);
            const rawType = match?.groups?.type?.toLowerCase();
            const description = match?.groups?.description || subject;

            let section = "Other changes";
            if (useConventionalCommits && rawType) {
              const typeToTitle = {
                feat: "Features",
                fix: "Bug fixes",
                perf: "Performance",
                refactor: "Refactors",
                docs: "Documentation",
                test: "Tests",
                build: "Build",
                ci: "CI",
                chore: "Chores",
                style: "Style",
                revert: "Reverts",
              };
              section = typeToTitle[rawType] || "Other changes";
            } else if (!useConventionalCommits) {
              section = "Changes";
            }

            if (!acc.has(section)) {
              acc.set(section, []);
            }

            acc.get(section).push(useConventionalCommits ? description : subject);
            return acc;
          }, new Map());

          const changes = [...groupedCommits.entries()]
            .map(([section, entries]) => `### ${section}\n${entries.map((entry) => `- ${entry}`).join("\n")}`)
            .join("\n\n")
            .trim();

          const llmPrompt = [
            "Summarize the following release changes as markdown:",
            `Base ref: ${baseRef}`,
            `Head ref: ${headRef}`,
            "",
            changes || "- No user-facing changes found.",
          ].join("\n");

          let llmSummary = llmSummaryInput;
          if (!llmSummary && llmSummaryCommand) {
            llmSummary = execSync(llmSummaryCommand, {
              encoding: "utf8",
              input: llmPrompt,
            }).trim();
          }

          const summary = llmSummary ? `### Summary\n${llmSummary}` : "";
          const changelog = markdownTemplate
            .replace(/\{\{base_ref\}\}/g, baseRef)
            .replace(/\{\{head_ref\}\}/g, headRef)
            .replace(/\{\{commit_count\}\}/g, `${commits.length}`)
            .replace(/\{\{summary\}\}/g, summary)
            .replace(/\{\{changes\}\}/g, changes)
            .trim();

          core.setOutput("commit-count", `${commits.length}`);
          core.setOutput("changes", changes);
          core.setOutput("llm-prompt", llmPrompt);
          core.setOutput("changelog", changelog);
