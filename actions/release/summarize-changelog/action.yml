name: "Release - Summarize changelog"
description: "Compile release changelog entries between two refs, with optional conventional commit grouping and LLM summary injection."
author: hoverkraft
branding:
  icon: file-text
  color: blue

inputs:
  base-ref:
    description: "Base git ref (excluded from the range)."
    required: true
  head-ref:
    description: "Head git ref (included in the range)."
    required: true
  conventional-commits:
    description: "Whether to group commit messages by conventional commit type."
    required: false
    default: "true"
  llm-summary:
    description: "Optional summary generated by any LLM provider."
    required: false
    default: ""
  llm-model:
    description: "Optional OpenAI-compatible model used to generate summary from `llm-prompt`."
    required: false
    default: ""
  llm-api-key:
    description: "Optional API key for the OpenAI-compatible model provider."
    required: false
    default: ""
  llm-base-url:
    description: "Optional OpenAI-compatible API base URL."
    required: false
    default: "https://api.openai.com/v1"
  llm-summary-command:
    description: "Optional command used to generate the summary from `llm-prompt` (prompt is sent through stdin)."
    required: false
    default: ""
  markdown-template:
    description: |
      Markdown template used to build the final changelog.
      Supported placeholders:
      - {{base_ref}}
      - {{head_ref}}
      - {{commit_count}}
      - {{summary}}
      - {{changes}}
    required: false
    default: |
      ## Changelog

      _Changes from `{{base_ref}}` to `{{head_ref}}`._

      {{summary}}

      {{changes}}

outputs:
  changelog:
    description: "Rendered markdown changelog."
    value: ${{ steps.summarize.outputs.changelog }}
  changes:
    description: "Compiled markdown list of changes."
    value: ${{ steps.summarize.outputs.changes }}
  llm-prompt:
    description: "Prompt text that can be sent to any LLM provider."
    value: ${{ steps.summarize.outputs.llm-prompt }}
  commit-count:
    description: "Number of commits included in the changelog."
    value: ${{ steps.summarize.outputs.commit-count }}

runs:
  using: "composite"
  steps:
    - uses: hoverkraft-tech/ci-github-common/actions/checkout@f24ce3360a8abf9bf386a62ab13d0ae5de5f9d13 # 0.31.7
      with:
        fetch-depth: "0"

    - shell: bash
      if: ${{ !inputs.llm-summary && inputs.llm-model != '' }}
      run: npm install --no-save openai@6.22.0

    - id: summarize
      uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
      env:
        BASE_REF: ${{ inputs.base-ref }}
        HEAD_REF: ${{ inputs.head-ref }}
        CONVENTIONAL_COMMITS: ${{ inputs.conventional-commits }}
        LLM_SUMMARY: ${{ inputs.llm-summary }}
        LLM_MODEL: ${{ inputs.llm-model }}
        LLM_API_KEY: ${{ inputs.llm-api-key }}
        LLM_BASE_URL: ${{ inputs.llm-base-url }}
        LLM_SUMMARY_COMMAND: ${{ inputs.llm-summary-command }}
        MARKDOWN_TEMPLATE: ${{ inputs.markdown-template }}
      with:
        script: |
          const summarize = require(`${process.env.GITHUB_ACTION_PATH}/summarize.js`);
          await summarize({ core });
